<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
        #allmap{height:500px;width:100%;}
        #r-result{width:100%; font-size:14px;}
    </style>
    <link href="/assets/libs/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/lr/jquery.lr_element.css" rel="stylesheet">
    <script src="/assets/libs/jquery/dist/jquery.js"></script>
    <script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&key={$qqApiKey}"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <title>补货员扫码</title>
</head>
<style>

</style>
<body>
<div id="searchbar">
</div>
<div id="allmap"></div>
</body>
</html>
<script type="text/javascript">
    var weixin_appid = '{$weixin_appid}';
    var userToken = '{$user_token}';
    var submitLoginUrl = '/adppp/station/api/bhy/login/';
    var getSmsToLoginApi = '/adppp/sms/api/index/send/';   //获取短信

    //微信公众号获取签名用
    (function (D) {
        function p(b, e, c) {
            var a = 0,
                d = [0],
                f = "",
                g = null,
                f = c || "UTF8";
            if ("UTF8" !== f && "UTF16" !== f) throw "encoding must be UTF8 or UTF16";
            if ("HEX" === e) {
                if (0 !== b.length % 2) throw "srcString of HEX type must be in byte increments";
                g = v(b);
                a = g.binLen;
                d = g.value
            } else if ("TEXT" === e) g = w(b, f), a = g.binLen, d = g.value;
            else if ("B64" === e) g = x(b), a = g.binLen, d = g.value;
            else if ("BYTES" === e) g = y(b), a = g.binLen, d = g.value;
            else throw "inputFormat must be HEX, TEXT, B64, or BYTES";
            this.getHash = function (b, f, c, e) {
                var g = null,
                    h = d.slice(),
                    l = a,
                    n;
                3 === arguments.length ? "number" !== typeof c && (e = c, c = 1) : 2 === arguments.length && (c = 1);
                if (c !== parseInt(c, 10) || 1 > c) throw "numRounds must a integer >= 1";
                switch (f) {
                    case "HEX":
                        g = z;
                        break;
                    case "B64":
                        g = A;
                        break;
                    case "BYTES":
                        g = B;
                        break;
                    default:
                        throw "format must be HEX, B64, or BYTES";
                }
                if ("SHA-1" === b)
                    for (n = 0; n < c; n += 1) h = s(h, l), l = 160;
                else throw "Chosen SHA variant is not supported";
                return g(h, C(e))
            };
            this.getHMAC = function (c, b, e, g, q) {
                var h, l, n, r, p = [],
                    t = [];
                h = null;
                switch (g) {
                    case "HEX":
                        g = z;
                        break;
                    case "B64":
                        g =
                            A;
                        break;
                    case "BYTES":
                        g = B;
                        break;
                    default:
                        throw "outputFormat must be HEX, B64, or BYTES";
                }
                if ("SHA-1" === e) l = 64, r = 160;
                else throw "Chosen SHA variant is not supported";
                if ("HEX" === b) h = v(c), n = h.binLen, h = h.value;
                else if ("TEXT" === b) h = w(c, f), n = h.binLen, h = h.value;
                else if ("B64" === b) h = x(c), n = h.binLen, h = h.value;
                else if ("BYTES" === b) h = y(c), n = h.binLen, h = h.value;
                else throw "inputFormat must be HEX, TEXT, B64, or BYTES";
                c = 8 * l;
                b = l / 4 - 1;
                if (l < n / 8) {
                    if ("SHA-1" === e) h = s(h, n);
                    else throw "Unexpected error in HMAC implementation";
                    h[b] &= 4294967040
                } else l > n / 8 && (h[b] &= 4294967040);
                for (l = 0; l <= b; l += 1) p[l] = h[l] ^ 909522486, t[l] = h[l] ^ 1549556828;
                if ("SHA-1" === e) e = s(t.concat(s(p.concat(d), c + a)), c + r);
                else throw "Unexpected error in HMAC implementation";
                return g(e, C(q))
            }
        }

        function w(b, e) {
            var c = [],
                a, d = [],
                f = 0,
                g;
            if ("UTF8" === e)
                for (g = 0; g < b.length; g += 1)
                    for (a = b.charCodeAt(g), d = [], 128 > a ? d.push(a) : 2048 > a ? (d.push(192 | a >>> 6), d.push(128 | a & 63)) : 55296 > a || 57344 <= a ? d.push(224 | a >>> 12, 128 | a >>> 6 & 63, 128 | a & 63) : (g += 1, a = 65536 + ((a & 1023) << 10 | b.charCodeAt(g) & 1023),
                        d.push(240 | a >>> 18, 128 | a >>> 12 & 63, 128 | a >>> 6 & 63, 128 | a & 63)), a = 0; a < d.length; a += 1) (f >>> 2) + 1 > c.length && c.push(0), c[f >>> 2] |= d[a] << 24 - f % 4 * 8, f += 1;
            else if ("UTF16" === e)
                for (g = 0; g < b.length; g += 1) (f >>> 2) + 1 > c.length && c.push(0), c[f >>> 2] |= b.charCodeAt(g) << 16 - f % 4 * 8, f += 2;
            return {value: c, binLen: 8 * f}
        }

        function v(b) {
            var e = [],
                c = b.length,
                a, d;
            if (0 !== c % 2) throw "String of HEX type must be in byte increments";
            for (a = 0; a < c; a += 2) {
                d = parseInt(b.substr(a, 2), 16);
                if (isNaN(d)) throw "String of HEX type contains invalid characters";
                e[a >>> 3] |=
                    d << 24 - a % 8 * 4
            }
            return {value: e, binLen: 4 * c}
        }

        function y(b) {
            var e = [],
                c, a;
            for (a = 0; a < b.length; a += 1) c = b.charCodeAt(a), (a >>> 2) + 1 > e.length && e.push(0), e[a >>> 2] |= c << 24 - a % 4 * 8;
            return {value: e, binLen: 8 * b.length}
        }

        function x(b) {
            var e = [],
                c = 0,
                a, d, f, g, m;
            if (-1 === b.search(/^[a-zA-Z0-9=+\/]+$/)) throw "Invalid character in base-64 string";
            a = b.indexOf("=");
            b = b.replace(/\=/g, "");
            if (-1 !== a && a < b.length) throw "Invalid '=' found in base-64 string";
            for (d = 0; d < b.length; d += 4) {
                m = b.substr(d, 4);
                for (f = g = 0; f < m.length; f += 1) a = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(m[f]),
                    g |= a << 18 - 6 * f;
                for (f = 0; f < m.length - 1; f += 1) e[c >> 2] |= (g >>> 16 - 8 * f & 255) << 24 - c % 4 * 8, c += 1
            }
            return {value: e, binLen: 8 * c}
        }

        function z(b, e) {
            var c = "",
                a = 4 * b.length,
                d, f;
            for (d = 0; d < a; d += 1) f = b[d >>> 2] >>> 8 * (3 - d % 4), c += "0123456789abcdef".charAt(f >>> 4 & 15) + "0123456789abcdef".charAt(f & 15);
            return e.outputUpper ? c.toUpperCase() : c
        }

        function A(b, e) {
            var c = "",
                a = 4 * b.length,
                d, f, g;
            for (d = 0; d < a; d += 3)
                for (g = (b[d >>> 2] >>> 8 * (3 - d % 4) & 255) << 16 | (b[d + 1 >>> 2] >>> 8 * (3 - (d + 1) % 4) & 255) << 8 | b[d + 2 >>> 2] >>> 8 * (3 - (d + 2) % 4) & 255, f = 0; 4 > f; f += 1) c = 8 * d + 6 * f <= 32 * b.length ? c +
                    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(g >>> 6 * (3 - f) & 63) : c + e.b64Pad;
            return c
        }

        function B(b) {
            var e = "",
                c = 4 * b.length,
                a, d;
            for (a = 0; a < c; a += 1) d = b[a >>> 2] >>> 8 * (3 - a % 4) & 255, e += String.fromCharCode(d);
            return e
        }

        function C(b) {
            var e = {outputUpper: !1, b64Pad: "="};
            try {
                b.hasOwnProperty("outputUpper") && (e.outputUpper = b.outputUpper), b.hasOwnProperty("b64Pad") && (e.b64Pad = b.b64Pad)
            } catch (c) {
            }
            if ("boolean" !== typeof e.outputUpper) throw "Invalid outputUpper formatting option";
            if ("string" !== typeof e.b64Pad) throw "Invalid b64Pad formatting option";
            return e
        }

        function q(b, e) {
            return b << e | b >>> 32 - e
        }

        function r(b, e) {
            var c = (b & 65535) + (e & 65535);
            return ((b >>> 16) + (e >>> 16) + (c >>> 16) & 65535) << 16 | c & 65535
        }

        function t(b, e, c, a, d) {
            var f = (b & 65535) + (e & 65535) + (c & 65535) + (a & 65535) + (d & 65535);
            return ((b >>> 16) + (e >>> 16) + (c >>> 16) + (a >>> 16) + (d >>> 16) + (f >>> 16) & 65535) << 16 | f & 65535
        }

        function s(b, e) {
            var c = [],
                a, d, f, g, m, p, u, k, s, h = [1732584193, 4023233417, 2562383102, 271733878, 3285377520];
            b[e >>> 5] |= 128 << 24 - e % 32;
            b[(e + 65 >>> 9 << 4) + 15] = e;
            s = b.length;
            for (u = 0; u < s; u += 16) {
                a = h[0];
                d = h[1];
                f = h[2];
                g = h[3];
                m = h[4];
                for (k = 0; 80 > k; k += 1) c[k] = 16 > k ? b[k + u] : q(c[k - 3] ^ c[k - 8] ^ c[k - 14] ^ c[k - 16], 1), p = 20 > k ? t(q(a, 5), d & f ^ ~d & g, m, 1518500249, c[k]) : 40 > k ? t(q(a, 5), d ^ f ^ g, m, 1859775393, c[k]) : 60 > k ? t(q(a, 5), d & f ^ d & g ^ f & g, m, 2400959708, c[k]) : t(q(a, 5), d ^ f ^ g, m, 3395469782, c[k]), m = g, g = f, f = q(d, 30), d = a, a = p;
                h[0] = r(a, h[0]);
                h[1] = r(d, h[1]);
                h[2] = r(f, h[2]);
                h[3] = r(g, h[3]);
                h[4] = r(m, h[4])
            }
            return h
        }

        "function" === typeof define && define.amd ? define(function () {
            return p
        }) : "undefined" !== typeof exports ? "undefined" !== typeof module && module.exports ? module.exports =
            exports = p : exports = p : D.jsSHA = p
    })(this);
    function tokenPost(options) {
        options = options || {};
        if(!options['post_data']) options['post_data'] = {};
        options['post_data']['token'] = userToken;
        postAndDone(options);
    }



    function login() {
        var diyForm = makeForm({
            'style': 'width: 90%;margin:0 auto 1.5rem auto;',
            'type': 'post',
            'url' : submitLoginUrl,
            value:  [
                makeTable({
                    tr_1: [{
                        id: 'account_tr',
                        td: [
                            {
                                padding_top: '20px',
                                value: [
                                    makeInput({
                                        name: 'your_mobile',
                                        size: 'lg',
                                        'class': 'btn-block no_radius_right' ,
                                        place: '您的手机',
                                        type: 'text',
                                        limit: 'int',
                                        maxlen: 11,
                                        value: '',
                                        null_func: function () {
                                            msgTisf('请输入您的手机');
                                        }
                                    })
                                ]
                            }
                            ,{
                                padding_top: '20px',
                                value:  makeBtn({value:'获取短信',
                                    size: 'lg',
                                    'class': 'btn btn-default btn-block no_radius_left',
                                    rest_time: '',
                                    click: function (obj) {
                                        var newTel = your_mobile.value;
                                        if (!newTel) {
                                            msgTisf('请输入您的手机');
                                            return;
                                        }
                                        tokenPost({
                                            post_url: getSmsToLoginApi,
                                            post_data: {
                                                mobile: newTel,
                                                'event': 'login',
                                            },
                                            success_key: 'code',
                                            success_value: '1',
                                            success_func: function () {
                                                msgTis('发送成功，请勿将手机短信告知他人');
                                                obj.subTime(60);
                                            },
                                            err_func: function (e) {
                                                msgTis(e.msg);
                                            }
                                        });
                                    }
                                })
                            }
                        ]
                    },{
                        td: [
                            {
                                padding_top: '10px',
                                value: makeInput({
                                    name:'code',
                                    size: 'lg',
                                    'class': 'btn-block no_radius_right',
                                    place:'短信验证码', type: 'text',
                                    limit: 'int', maxlen: 6,
                                    value: '',
                                    null_func: function () {
                                        msgTis('验证码呢？');
                                    }
                                })
                            },
                            {
                                padding_top: '10px',
                                value: makeBtn({
                                    type:'submit',
                                    size: 'lg',
                                    value:'登录',
                                    'class': 'btn btn-info btn-block no_radius_left'
                                })
                            }
                        ]
                    } ]
                })],
            success_key: 'code',
            success_value: '1',
            success_func: function (data) {
                noLoading();
                hideNewBox();
                msgTisf(data.msg);
                var lastUrl = location.href;
                if(lastUrl.indexOf('?') !=-1) {
                    window.location.href = location.href + '&time='+((new Date()).getTime());
                } else {
                    window.location.href = location.href + '?time='+((new Date()).getTime());
                }
            },
            submit: function (data) {
                loading(true);
            },
            err_func: function (data) {
                noLoading();
                msgTisf('登录失败:'+ data.msg);
            }
        });
        msgWin('补货员登录', diyForm, 400, 1,{
            bg: true,//背景遮挡
            'class': 'new_loginbox',
            'canDrag': false,
            'closeBtn': false
        });
    }
    function wx_js(signature, timestamp, nonceStr) {
        var e = decodeURIComponent('jsapi_ticket=' + signature + '&noncestr=' + nonceStr + '&timestamp=' + timestamp + '&url=' + location.href.split("#")[0]),
            s = new jsSHA(e, "TEXT"),
            signature = s.getHash("SHA-1", "HEX");
        return signature;
    }
    if (!userToken) {
        msgTisf('请先登录');
        login();
    } else {
        tokenPost({
            post_url: '/admin/addon/weixinpay/api/index/getScannerTicket',
            success_key: 'code',
            success_value: '1',
            success_func: function (res) {
                var timestamp = (new Date().getTime() / 1000).toFixed(0);
                var nonceStr = Math.random().toString(36).substr(2);
                var ticket = wx_js(res.data.ticket, timestamp, nonceStr);
                var isBuyer = res.data.isBuyer;
                var nickname = res.data.nickname;
                var appid = res.data.appid;
                // console.log('ticket:'+ ticket);
                // console.log('appid:'+ appid);
                wx.config({
                    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端//alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: appid, // 必填，公众号的唯一标识
                    timestamp: timestamp, // 必填，生成签名的时间戳
                    nonceStr: nonceStr, // 必填，生成签名的随机串
                    signature: ticket, // 必填，签名，见附录1
                    jsApiList: ['checkJsApi',
                        'onMenuShareTimeline',
                        'onMenuShareAppMessage',
                        'onMenuShareQQ',
                        'onMenuShareWeibo',
                        'hideMenuItems',
                        'showMenuItems',
                        'hideAllNonBaseMenuItem',
                        'showAllNonBaseMenuItem',
                        'translateVoice',
                        'startRecord',
                        'stopRecord',
                        'onRecordEnd',
                        'playVoice',
                        'pauseVoice',
                        'stopVoice',
                        'uploadVoice',
                        'downloadVoice',
                        'chooseImage',
                        'previewImage',
                        'uploadImage',
                        'downloadImage',
                        'getNetworkType',
                        'openLocation',
                        'getLocation',
                        'hideOptionMenu',
                        'showOptionMenu',
                        'closeWindow',
                        'scanQRCode',
                        'chooseWXPay',
                        'openProductSpecificView',
                        'addCard',
                        'chooseCard',
                        'openCard'
                    ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                });
                wx.ready(function () {
                    // console.log('wx.ready:');
                    wx.scanQRCode({
                        needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                        scanType: ["qrCode", "barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                        success: function (res) {
                            // alert(JSON.stringify(res));
                            var id = res.resultStr;
                            if(isBuyer) {
                                msgTisf('您不是补货员:'+ nickname);
                                return;
                            }
                            location = '/wap#buhuoCupboard?id='+ id;
                            // if(isBuyer) {
                            //     location = '/wap#buhuoCupboard?id='+ id;
                            // } else {
                            //     location = '/wap#cupboard?id='+ id;
                            // }
                        },
                        error: function (err) {
                            msgTisf(err);
                        }
                    });
                });
            }
        });
    }
    document.title = '补货员扫码';

</script>
