<!DOCTYPE html>
<html>
<head>
{include file="common/meta" /}
</head>
<base target="_parent" />
<body>
{include file="common/header" /}
{include  file="common/banner" currentBanner='musicTime' /}
<link href="/assets/css/juzi/myMusic.css" rel="stylesheet">
<script src="/assets/js/juzi/player.js"></script>
<div class="front_body container">
    <div class="panel panel-info">
        {include  file="common/musicTimeTopMy" keyword='$keyword' /}
    </div>
</div>
<div class="front_body container">
    <div class="panel panel-info">
        <div class="panel-heading" style="position: relative;">
            <?php
            if($keyword) {
               echo "我的歌曲, 关键词:".$keyword;
            } else {
               echo "我的歌曲";
            }
            ?>

        </div>
        <div class="panel-body" id="musicListBox">
            <table class="table table-striped">
                <tr>
                    <th>
                        歌曲
                    </th>
                    <th>
                        歌曲文件
                    </th>
                    <th>
                        心情
                    </th>
                    <th>
                        公开
                    </th>
                    <th>
                        发布时间
                    </th>
                    <th>
                        操作
                    </th>
                </tr>
                <?php
                foreach($list as $v) {
                ?>
                <tr data-id="<?=$v['id']?>">
                    <td>
                        <a href="/juzi/Musictime/liList/id/<?=$v['id']?>" target="_blank">
                            <?=$v['songTitle']?> <br /> <?=$v['singer']?>
                        </a>
                    </td>
                    <td>
                        <?=$v['songFile']?>
                    </td>
                    <td>
                        <?=$v['articles']?>
                    </td>
                    <td>
                        <?=$v['opened']?>
                    </td>
                    <td>
                        <?=$v['ctime']?>
                    </td>
                    <td>
                        <a class="btn btn-xs btn-default" href="/juzi/Musictime/post/?id=<?=$v['id']?>" target="_blank">编辑</a>
                        <button class="btn btn-xs btn-default musicFileBtn">上传歌曲</button>
                        <div class="line3"></div>
                        <a class="btn btn-xs btn-default" href="/juzi/Musictime/write/?id=<?=$v['id']?>" target="_blank">写心情</a>
                        <a class="btn btn-xs btn-default" href="/juzi/Musictime/liList/id/<?=$v['id']?>" target="_blank">心情记录</a>
                    </td>
                </tr>
                <?php
                }
                ?>
                <?php
                if($nullStr) {
                ?>
                <tr>
                    <td colspan="6">
                        <div class="alert alert-warning">
                            <?=$nullStr?>
                        </div>
                    </td>
                </tr>
                <?php
            }
            ?>
            </table>
            <?=$pageMenu?>
        </div>
    </div>
</div>
<script>

    (function (global__, $) {
        $(document).ready(function () {
            var getMusicUrl = '/juzi/Musictime/getMusicToPlay/';
            var uploadMusicUrl = '/adppp/fujian/index/upload/?addon=juzi.Musictimemodel&uniqueMethod=deleteOldMusic&isImg=0&filetype=mp3,wma&addon_source_id=';
            var listBox = $('#musicListBox');
            //播放
            listBox.find('.playBtn').click(function () {
                var btn_ = $(this);
                listBox.find('.routing').removeClass('routing').attr('title', '播放');
                btn_.addClass('routing').attr('title', '播放中');
                var id_ = btn_.closest('tr').attr('data-id');
                loadingSvg(true);
                rePost(getMusicUrl, {
                    musicId: id_
                }, function (res) {
                    noLoading();
                    if(res.code==0) {
                        msgTis(res.msg);
                    } else {
                        var appendVoiceWhere = $('body');
                        showVoicePlayer(appendVoiceWhere, res.data.songPathUrl, res.data.songTime);
                    }
                })
            });

            //上传
            listBox.find('.musicFileBtn').click(function () {
                hideAllBox();
                var btn_ = $(this);
                var id_ = btn_.closest('tr').attr('data-id');
                if(isNaN(id_)) {
                    msgTis('id异常,不是数字');
                    return;
                }
                var fileForm = makeDiv({
                    value: [
                        makeDiv({
                            style: 'margin-bottom: 12px;',
                            value: '支持MP3/wma,最大20M,每次上传会覆盖之前的文件'
                        }),
                        makeInput({
                            type: 'file',
                            url: uploadMusicUrl + id_,
                            'class': 'cloud',
                            name: 'row[musicFile]',
                            success_key: 'code',
                            success_value: '1',
                            success_func: function (input_, response) {
                                noLoading();
                                hideAllBox();
                                msgTisf(response['msg']);
                            },
                            err_func: function (response) {
                                noLoading();
                                msgTisf(response.msg);
                            },
                            change: function () {
                                loadingSvg(true);
                            }
                        })
                    ]
                });
                msgView('上传歌曲文件', fileForm,  '400px', 100, {fx: 'd', jl: '100px'});
            });

        });
    })(this, jQuery);
</script>
{include file="common/footer" /}
</body>
</html>